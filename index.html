<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Chromebooks NSG - 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --excel-green: #107c41; --excel-dark: #0b5c2f; }
        body { 
            background-color: #f4f7f6; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .excel-header { background-color: var(--excel-green); color: white; padding: 12px 20px; border-bottom: 4px solid var(--excel-dark); z-index: 1030; }
        .table-container { background: white; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        
        th { background-color: #f8f9fa !important; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #6c757d; }
        td { font-size: 0.88rem; vertical-align: middle; border-color: #f1f1f1 !important; }
        
        .month-nav { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; }
        .nav-btn { background: var(--excel-green); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .nav-btn:hover { background: var(--excel-dark); transform: scale(1.1); }
        
        .week-tabs { display: flex; gap: 8px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        .week-tab { padding: 6px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 20px; font-size: 0.85rem; transition: 0.3s; }
        .week-tab.active { background: var(--excel-green); color: white; border-color: var(--excel-green); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card-chart { background: white; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 20px; }
        #chartDocenteContainer { height: 300px; overflow-y: auto; scrollbar-width: thin; }

        .quick-edit-input { font-size: 0.8rem; border: 1px solid transparent; background-color: transparent; transition: 0.2s; text-align: center; border-radius: 4px; width: 100%; }
        .quick-edit-input:hover { border-color: #ced4da; background-color: #fff; }
        .quick-edit-input:focus { background-color: #fffbe0; border-color: #ffc107; outline: none; box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2); }
        
        /* Footer con tus derechos */
        .nsg-footer {
            background-color: #333;
            color: #ccc;
            padding: 15px 0;
            text-align: center;
            font-size: 0.85rem;
            margin-top: auto;
            border-top: 3px solid var(--excel-green);
        }
        .nsg-footer b { color: white; }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 fw-bold text-success text-uppercase">Sincronizando...</div>
    </div>

    <div class="excel-header container-fluid d-flex justify-content-between align-items-center sticky-top">
        <div>
            <h5 class="m-0 fw-bold">üìÖ Gesti√≥n Chromebooks 2026</h5>
            <small class="opacity-75">Panel de Control Tec. Inform√°tico</small>
        </div>
        <div>
            <button class="btn btn-light btn-sm fw-bold shadow-sm" onclick="loadData()">üîÑ Actualizar</button>
            <button class="btn btn-warning btn-sm fw-bold shadow-sm ms-2" onclick="openModal()">+ Nueva Reserva</button>
        </div>
    </div>

    <div class="container-fluid mt-3 flex-grow-1">
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">&#10094;</button>
            <h3 id="currentMonthLabel" class="m-0 fw-bold text-dark" style="min-width: 200px; text-align: center;">Marzo 2026</h3>
            <button class="nav-btn" onclick="changeMonth(1)">&#10095;</button>
        </div>

        <div class="week-tabs" id="weekTabs"></div>

        <div class="row mb-3 g-2 align-items-center">
            <div class="col-md-3">
                <select id="filterCurso" class="form-select form-select-sm shadow-sm" onchange="renderApp()">
                    <option value="">Todos los Cursos</option>
                    <optgroup label="B√°sica">
                        <option value="1¬∞ A">1¬∞ A</option><option value="1¬∞ B">1¬∞ B</option>
                        <option value="2¬∞ A">2¬∞ A</option><option value="2¬∞ B">2¬∞ B</option>
                        <option value="3¬∞ A">3¬∞ A</option><option value="3¬∞ B">3¬∞ B</option>
                        <option value="4¬∞ A">4¬∞ A</option><option value="4¬∞ B">4¬∞ B</option>
                        <option value="5¬∞ A">5¬∞ A</option><option value="5¬∞ B">5¬∞ B</option>
                        <option value="6¬∞ A">6¬∞ A</option><option value="6¬∞ B">6¬∞ B</option>
                        <option value="7¬∞ A">7¬∞ A</option><option value="7¬∞ B">7¬∞ B</option>
                        <option value="8¬∞ A">8¬∞ A</option><option value="8¬∞ B">8¬∞ B</option>
                    </optgroup>
                    <optgroup label="Media">
                        <option value="I¬∞m A">I¬∞m A</option><option value="I¬∞m B">I¬∞m B</option>
                        <option value="II¬∞m A">II¬∞m A</option><option value="II¬∞m B">II¬∞m B</option>
                        <option value="III¬∞m A">III¬∞m A</option><option value="III¬∞m B">III¬∞m B</option>
                        <option value="IV¬∞m A">IV¬∞m A</option><option value="IV¬∞m B">IV¬∞m B</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" id="filterProfesor" class="form-control form-control-sm shadow-sm" placeholder="üîç Buscar Profesor..." onkeyup="renderApp()">
            </div>
            <div class="col-md-6 text-end">
                <span class="badge bg-dark px-3 py-2 shadow-sm" id="totalCount">Cargando...</span>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="table-container shadow-sm">
                    <div class="table-responsive" style="max-height: 750px;">
                        <table class="table table-hover m-0 table-sm text-center" id="mainTable">
                            <thead class="sticky-top" style="z-index: 10;">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Curso</th>
                                    <th class="text-start">Asignatura</th>
                                    <th class="text-start">Profesor</th>
                                    <th>Chr.</th>
                                    <th>Ree.</th>
                                    <th>Dev.</th>
                                    <th style="width: 20%;">Observaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card-chart">
                    <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3">Estad√≠sticas por Docente</h6>
                    <div id="chartDocenteContainer"><canvas id="chartDocente"></canvas></div>
                </div>
                
                <div class="card-chart" style="height: 250px;">
                    <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3">Uso por Asignatura</h6>
                    <canvas id="chartAsignatura"></canvas>
                </div>

                <div class="card-chart" style="height: 220px;">
                    <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3">Equipos Solicitados</h6>
                    <canvas id="chartEquipos"></canvas>
                </div>

                <div class="card-chart" style="height: 220px;">
                    <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3">Estado T√©cnico</h6>
                    <canvas id="chartObservaciones"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="nsg-footer">
        Derechos Reservados - <b>NSG 2026</b> - Por <b>Franco</b>
    </footer>

    <div class="modal fade" id="reservationModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">Nueva Reserva</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="resForm">
                        <input type="hidden" id="fId"> 
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">Fecha</label>
                                <input type="date" id="fFecha" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Hora</label>
                                <select id="fHora" class="form-select">
                                    <option>08:10</option><option>10:00</option><option>11:50</option>
                                    <option>13:20</option><option>14:05</option><option>15:35</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Curso</label>
                                <input type="text" id="fCurso" class="form-control" placeholder="Ej: 2¬∞ Medio A">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Asignatura</label>
                                <input type="text" id="fAsignatura" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Profesor/a</label>
                                <input type="text" id="fProfesor" class="form-control">
                            </div>
                            <div class="col-4">
                                <label class="form-label small fw-bold text-primary">Chrome.</label>
                                <input type="number" id="fChrome" class="form-control" value="0">
                            </div>
                            <div class="col-4">
                                <label class="form-label small fw-bold text-danger">Reempl.</label>
                                <input type="number" id="fReemp" class="form-control" value="0">
                            </div>
                            <div class="col-4">
                                <label class="form-label small fw-bold text-success">Dev.</label>
                                <input type="number" id="fDev" class="form-control" value="0">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Estado Inicial</label>
                                <select id="fObs" class="form-select">
                                    <option value="Sin novedad">‚úÖ Sin novedad</option>
                                    <option value="Pantalla Da√±ada">üî¥ Pantalla Da√±ada</option>
                                    <option value="Teclado Falla">üü† Teclado Falla</option>
                                    <option value="No Enciende">‚ö´ No Enciende</option>
                                    <option value="Cargador Malo">üîå Cargador Malo</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success px-4" onclick="saveReservation()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyWgn7OUWOg4Mt4WkZ8At4-4iD6R03i9-kr0HKskhdq9aCp0w7NGv96_feqqkbHZB8/exec"; 

        let dbData = [];
        const months = ["Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let currentMonthIndex = 0; 
        let currentWeek = 0; 
        let year = 2026;

        document.addEventListener('DOMContentLoaded', () => {
            renderWeeks();
            loadData();
        });

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function loadData() {
            showLoading(true);
            fetch(SCRIPT_URL)
                .then(res => res.json())
                .then(data => {
                    dbData = data;
                    renderApp();
                    showLoading(false);
                })
                .catch(err => {
                    console.error(err);
                    showLoading(false);
                });
        }

        function renderApp() {
            const selectedMonthNum = currentMonthIndex + 3; 
            const filterC = document.getElementById('filterCurso').value; 
            const filterP = document.getElementById('filterProfesor').value.toLowerCase();

            let filtered = dbData.filter(item => {
                const parts = item.fecha.split('-');
                const itemYear = parseInt(parts[0]);
                const itemMonth = parseInt(parts[1]);
                
                if (itemYear !== year || itemMonth !== selectedMonthNum) return false;
                if (currentWeek !== 0 && getWeekNumber(item.fecha) !== currentWeek) return false;
                
                // FILTRO EXACTO PARA CURSO
                if (filterC && item.curso !== filterC) return false;
                
                if (filterP && !item.profesor.toLowerCase().includes(filterP)) return false;
                return true;
            });

            filtered.sort((a, b) => a.fecha.localeCompare(b.fecha) || a.hora.localeCompare(b.hora));

            const tbody = document.getElementById('tableBody');
            let htmlBuffer = '';
            if (filtered.length === 0) {
                htmlBuffer = '<tr><td colspan="10" class="text-muted p-5">No hay registros</td></tr>';
            } else {
                filtered.forEach(row => {
                    htmlBuffer += `
                        <tr>
                            <td class="fw-bold text-secondary">${formatDateCL(row.fecha)}</td>
                            <td><span class="badge bg-light text-dark border">${row.hora}</span></td>
                            <td>${row.curso}</td>
                            <td class="text-start">${row.asignatura}</td>
                            <td class="text-start fw-semibold text-primary">${row.profesor}</td>
                            <td>${row.chromebooks}</td>
                            <td class="${row.reemplazo > 0 ? 'text-danger fw-bold' : ''}">${row.reemplazo}</td>
                            <td class="text-success">${row.devueltos}</td>
                            <td>
                                <input type="text" class="quick-edit-input" value="${row.observacion || ''}" 
                                    onblur="quickUpdateObservation('${row.id}', this.value)" placeholder="...">
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-warning border-0" onclick="editItem('${row.id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteItem('${row.id}')">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>`;
                });
            }
            tbody.innerHTML = htmlBuffer;
            document.getElementById('totalCount').innerText = `${filtered.length} Registros`;
            updateCharts(filtered);
        }

        function quickUpdateObservation(id, newObservation) {
            const item = dbData.find(d => d.id.toString() === id.toString());
            if (!item || item.observacion === newObservation) return; 
            showLoading(true);
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ ...item, action: "update", observacion: newObservation }) })
            .then(() => loadData());
        }

        function saveReservation() {
            const id = document.getElementById('fId').value;
            showLoading(true);
            const payload = {
                action: id ? "update" : "create",
                id: id,
                fecha: document.getElementById('fFecha').value,
                hora: document.getElementById('fHora').value,
                curso: document.getElementById('fCurso').value,
                asignatura: document.getElementById('fAsignatura').value,
                profesor: document.getElementById('fProfesor').value,
                chromebooks: document.getElementById('fChrome').value,
                reemplazo: document.getElementById('fReemp').value,
                devueltos: document.getElementById('fDev').value,
                observacion: document.getElementById('fObs').value
            };
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('reservationModal')).hide();
                loadData();
            });
        }

        function deleteItem(id) {
            if(!confirm("¬øEliminar registro?")) return;
            showLoading(true);
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "delete", id: id }) }).then(() => loadData());
        }

        function openModal() {
            document.getElementById('resForm').reset();
            document.getElementById('fId').value = "";
            new bootstrap.Modal(document.getElementById('reservationModal')).show();
        }

        function editItem(id) {
            const item = dbData.find(d => d.id.toString() === id.toString());
            if (!item) return;
            document.getElementById('fId').value = item.id;
            document.getElementById('fFecha').value = item.fecha;
            document.getElementById('fHora').value = item.hora;
            document.getElementById('fCurso').value = item.curso;
            document.getElementById('fAsignatura').value = item.asignatura;
            document.getElementById('fProfesor').value = item.profesor;
            document.getElementById('fChrome').value = item.chromebooks || 0;
            document.getElementById('fReemp').value = item.reemplazo || 0;
            document.getElementById('fDev').value = item.devueltos || 0;
            document.getElementById('fObs').value = item.observacion;
            new bootstrap.Modal(document.getElementById('reservationModal')).show();
        }

        function changeMonth(step) {
            let newIndex = currentMonthIndex + step;
            if (newIndex >= 0 && newIndex < months.length) { 
                currentMonthIndex = newIndex; currentWeek = 0;
                renderWeeks(); renderApp();
            }
        }

        function setWeek(weekNum) { currentWeek = weekNum; renderWeeks(); renderApp(); }

        function renderWeeks() {
            const container = document.getElementById('weekTabs');
            let html = `<div class="week-tab ${currentWeek === 0 ? 'active' : ''}" onclick="setWeek(0)">Mes Completo</div>`;
            for(let i=1; i<=4; i++) html += `<div class="week-tab ${currentWeek === i ? 'active' : ''}" onclick="setWeek(${i})">Semana ${i}</div>`;
            container.innerHTML = html;
            document.getElementById('currentMonthLabel').innerText = `${months[currentMonthIndex]} ${year}`;
        }

        function getWeekNumber(dateString) {
            const day = parseInt(dateString.split('-')[2]);
            return day <= 7 ? 1 : day <= 14 ? 2 : day <= 21 ? 3 : 4;
        }

        function formatDateCL(dateStr) {
            const p = dateStr.split('-'); return `${p[2]}/${p[1]}`;
        }

        let chartAsig, chartObs, chartEq, chartDocente;

        function updateCharts(data) {
            const counts = { asig: {}, obs: {}, docs: {}, equipos: { chr: 0, ree: 0 } };
            data.forEach(d => {
                counts.asig[d.asignatura] = (counts.asig[d.asignatura] || 0) + 1;
                counts.obs[d.observacion] = (counts.obs[d.observacion] || 0) + 1;
                counts.equipos.chr += parseInt(d.chromebooks || 0);
                counts.equipos.ree += parseInt(d.reemplazo || 0);
                if (d.profesor) {
                    if (!counts.docs[d.profesor]) counts.docs[d.profesor] = { res: 0, fail: 0 };
                    counts.docs[d.profesor].res += 1;
                    if (/(da√±ada|falla|no enciende|malo)/i.test(d.observacion)) counts.docs[d.profesor].fail += 1;
                }
            });

            // Chart Docentes
            const docLabels = Object.keys(counts.docs).sort((a,b) => counts.docs[b].res - counts.docs[a].res);
            if(chartDocente) chartDocente.destroy();
            document.getElementById('chartDocenteContainer').style.height = `${Math.max(300, docLabels.length * 35)}px`;
            chartDocente = new Chart(document.getElementById('chartDocente'), {
                type: 'bar',
                data: { labels: docLabels, datasets: [{ label: 'Reservas', data: docLabels.map(l => counts.docs[l].res), backgroundColor: '#107c41' }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });

            // Gr√°fico Asignaturas (BARRAS)
            if(chartAsig) chartAsig.destroy();
            chartAsig = new Chart(document.getElementById('chartAsignatura'), {
                type: 'bar',
                data: { labels: Object.keys(counts.asig), datasets: [{ label: 'Reservas', data: Object.values(counts.asig), backgroundColor: '#4285f4' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Gr√°fico Equipos (BARRAS)
            if(chartEq) chartEq.destroy();
            chartEq = new Chart(document.getElementById('chartEquipos'), {
                type: 'bar',
                data: { labels: ['Chromebooks', 'Reemplazos'], datasets: [{ label: 'Cantidad', data: [counts.equipos.chr, counts.equipos.ree], backgroundColor: ['#107c41', '#db4437'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Gr√°fico Observaciones
            if(chartObs) chartObs.destroy();
            chartObs = new Chart(document.getElementById('chartObservaciones'), {
                type: 'bar',
                data: { labels: Object.keys(counts.obs), datasets: [{ data: Object.values(counts.obs), backgroundColor: '#ffc107' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
